<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Bar Review Notes</title>
    <link rel="icon" href="https://raw.githubusercontent.com/ariiannemay/2026-Bar-Exam-Tracker/main/Images/LAWLOGO_FAVICON.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Bebas+Neue&family=Dancing+Script:wght@600&display=swap');

        :root {
            --color-primary-dark: #330066; 
            --color-secondary-gold: #B266FF; 
            --color-light-bg: #F4F7F9;
        }

        body { background-color: var(--color-light-bg); font-family: 'Inter', sans-serif; }
        .header-font { font-family: 'Bebas Neue', sans-serif; letter-spacing: .1em; }
        .header-bg { background-color: #330066; border-bottom: 5px solid #B266FF; }

        .tab-btn {
            transition: all 0.2s; font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.05em; font-size: 0.8rem; border: none !important;
        }
        .tab-btn.active {
            color: white !important; background-color: #330066 !important;
            border-bottom: 2px solid #B266FF !important;
        }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }

#subject-tabs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Force full width expansion */
    gap: 0.5rem;
    width: 100%;
}

/* --- SUBJECT SPECIFIC TABS --- */
.sub-tab-btn[data-sub="poli"].active { background-color: #795548 !important; border-color: #795548 !important; }
.sub-tab-btn[data-sub="civ"].active { background-color: #1e3a8a !important; border-color: #3b82f6 !important; }
.sub-tab-btn[data-sub="rem"].active { background-color: #674ea7 !important; border-color: #8b5cf6 !important; }
.sub-tab-btn[data-sub="lab"].active { background-color: #38761d !important; border-color: #38761d !important; }
.sub-tab-btn[data-sub="tax"].active { background-color: #eab308 !important; border-color: #eab308 !important; }
.sub-tab-btn[data-sub="crim"].active { background-color: #b33a3a !important; border-color: #ef4444 !important; }

/* Master Progress Bar Styling */
#master-progress-wrapper {
    background: #e5e7eb;
    border-radius: 999px;
    height: 8px;
    overflow: hidden;
    margin-bottom: 2rem;
    border: 1px solid #d1d5db;
}
#master-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #330066, #B266FF);
    width: 0%;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.sub-tab-btn {
    width: 100%;
    font-size: 0.75rem; 
    font-weight: 800; 
    text-transform: uppercase;
    padding: 10px 4px; 
    border-radius: 8px; 
    transition: all 0.2s;
    border: 1px solid #e5e7eb; 
    background: white; 
    color: #4b5563;
    text-align: center;
}

/* Match the color coding of your #AweSAMBar2026 brand */
.sub-tab-btn.active { 
    background: var(--color-primary-dark); /* #330066 */
    color: white; 
    border-color: var(--color-secondary-gold); /* #B266FF */
    box-shadow: 0 4px 6px -1px rgba(178, 102, 255, 0.2);
}

.sub-tab-btn:hover:not(.active) {
    background: #f3e8ff;
    border-color: #d8b4fe;
}

.auto-expand {
    font-family: 'Inter', sans-serif; /* Back to clean default */
    font-size: 0.95rem;
    line-height: 1.6; 
    padding: 1rem; 
    width: 100%; 
    min-height: 120px;
    background-color: #ffffff; /* Clean white */
    border: 1px solid #e5e7eb; 
    border-radius: 8px;
    resize: none; 
    overflow: hidden; 
    display: block;
    color: #374151;
}

/* UI for the Export Button */
.export-btn {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
    background: #f3f4f6;
    color: #4b5563;
    border: 1px solid #d1d5db;
}

.export-btn:hover {
    background: #330066;
    color: white;
    border-color: #B266FF;
}

        .todo-paper {
            background: white; background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 24px 24px; min-height: 600px; border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* Custom grid logic for the pill links */
#links-grid > a:last-child:nth-child(odd) {
    grid-column: span 2; /* If it's the 3rd, 5th, etc link, it spans both columns */
}

.link-pill {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-radius: 12px;
    color: white;
    font-weight: 800;
    text-transform: uppercase;
    font-size: 0.8rem;
    transition: all 0.2s;
    position: relative;
}

.link-pill:hover {
    transform: translateY(-2px);
    filter: brightness(1.1);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.delete-link {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0;
    transition: 0.2s;
}

.link-pill:hover .delete-link {
    opacity: 1;
}
/* TO-DO LAYOUT & MINI-CALENDARS */
    .daily-layout-grid {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 2rem;
        min-height: 600px;
    }

.task-input-small {
    font-size: 9px !important; 
    font-weight: 600;
    line-height: 1.2;
    word-wrap: break-word;
    white-space: normal;
    overflow-wrap: anywhere;
    flex: 1;
    min-width: 0;
    height: auto;
}

.task-input-large { 
    font-size: 14px !important; 
    font-weight: 700; 
    color: var(--color-primary-dark); 
}

.mini-calendar-sidebar { border-left: 1px dashed #e5e7eb; padding-left: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; }
    .weekly-calendar-footer { display: flex; gap: 1rem; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #e5e7eb; }
    .weekly-calendar-footer .mini-cal { flex: 1; }

/* Updated Weekly Planner Layout */
    .weekly-planner-grid {
        display: grid;
        grid-template-columns: 1fr 300px; /* Planner on left, Cal on right */
        gap: 2rem;
        align-items: start;
    }

.weekly-tasks-stack {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* 3 columns for Sun-Fri */
        gap: 1rem;
    }

.weekly-day-card {
        background: rgba(255, 255, 255, 0.5);
        border-radius: 12px;
        padding: 1rem;
        border: 1px solid #f3e8ff;
        height: 100%; 
        min-height: 200px;
        display: flex;
        flex-direction: column;
        text-align: left; /* Back to left-aligned! */
    }

    /* Optional: Ensure Saturday also follows a similar height or stays larger */
    .weekly-day-card.saturday-span {
        grid-column: 1 / -1;
        min-height: 150px; 
    }

    .mini-cal {
        background: #fff; border-radius: 8px; padding: 0.75rem; width: 100%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #f3f4f6;
    }

    .mini-cal-header {
        font-weight: 900; font-size: 0.7rem; text-transform: uppercase;
        color: var(--color-primary-dark); text-align: center; margin-bottom: 0.5rem;
        border-bottom: 2px solid var(--color-secondary-gold);
    }

    .mini-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; font-size: 0.6rem; }
    .mini-cal-day-label { font-weight: 800; color: #9ca3af; padding-bottom: 4px; }
    .mini-cal-date { padding: 4px 0; border-radius: 4px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .mini-cal-date:hover { background: #f3f4f6; color: var(--color-primary-dark); }
    .mini-cal-today { background-color: var(--color-secondary-gold); color: white; }
    .mini-cal-viewing { outline: 2px solid var(--color-primary-dark); font-weight: 900; }

.todo-mode-btn {
    transition: all 0.2s;
}

/* Only the active one should be white with purple text */
.todo-mode-btn.selected-active {
    background-color: white !important;
    color: var(--color-primary-dark) !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* The non-selected one should always stay transparent with white text */
.todo-mode-btn:not(.selected-active) {
    background-color: transparent !important;
    color: white !important;
}

/* Weekly View Column Fixes */
.task-row {
    display: flex;
    align-items: center; 
    gap: 0.5rem; /* Reduced gap */
    padding: 0.25rem 0.5rem; /* Reduced vertical padding */
    border-bottom: 1px dashed #e5e7eb;
    width: 100%;
    transition: all 0.2s;
    border-radius: 6px;
}

.task-row:hover {
    background-color: rgba(178, 102, 255, 0.05);
    outline: 1px solid rgba(178, 102, 255, 0.2);
}

.task-row textarea {
    flex: 1;
    min-width: 0;
    background: transparent;
    border: none;
    outline: none;
    resize: none;
    margin: 0;
    padding: 4px 0;
    display: block; 
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    height: auto; 
    width: 100%;
}

.day-pill-header {
    background: #f3e8ff; 
    border-radius: 8px; 
    padding: 12px 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    border: 1px solid #e9d5ff;
    width: 100%; /* Spans the full width of the flex-1 container */
    box-sizing: border-box; /* Critical: ensures border doesn't push width out */
}

/* Make Weekday Font Larger */
.day-pill-header span:first-child {
    font-size: 14px !important; /* Increased from 10px */
    letter-spacing: 0.05em;
}

/* Make Add Task Thinner */
.add-task-btn-thin {
    padding-top: 2px !important;
    padding-bottom: 2px !important;
    min-height: unset !important;
    line-height: 1.5 !important;
}

/* Custom Checkbox Styling */
.task-row input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #B266FF;
    border-radius: 4px;
    background-color: white;
    cursor: pointer;
    position: relative;
    flex-shrink: 0;
    margin-top: 2px; /* Pulls checkbox down slightly to match first line of text */
    transition: all 0.2s;
}

.task-row input[type="checkbox"]:checked {
    background-color: #B266FF;
    border-color: #330066;
}

.task-row input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    left: 6px;
    top: 2px;
    width: 5px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}
.task-actions {
    display: flex;
align-items: center; /* Centers trash icon with text */
    flex-shrink: 0;
    gap: 0.25rem;
    /* Use margin-top to align with the first line of text */
    margin-top: 4px; 
}

.task-actions i {
    width: 0.8rem !important; 
    height: 0.8rem !important;
}

/* Fixes the "white box" selected pill issue */
.todo-mode-btn.bg-white {
    background-color: white !important;
    color: var(--color-primary-dark) !important;
}

#todo-render-container .text-gray-400.font-bold {
    font-size: 8px !important;
    white-space: nowrap; /* Keeps the month and day on one line */
    letter-spacing: -0.02em;
}

.todo-column:nth-child(even) {
    background-color: rgba(178, 102, 255, 0.03);
}


.clear-all-btn {
    padding: 2px 6px !important;
    border: 1px solid #fee2e2;
    background: #fef2f2;
    color: #ef4444;
    font-size: 8px !important;
    border-radius: 4px;
    text-transform: uppercase;
    font-weight: 800;
    transition: all 0.2s;
}

.clear-all-btn:hover {
    background: #ef4444;
    color: white;
}
/* --- THEMED MODAL SYSTEM --- */
#themed-modal-container {
    transition: all 0.3s ease-in-out;
}

.modal-animate-in {
    animation: modalScaleUp 0.2s ease-out forwards;
}

@keyframes modalScaleUp {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}

.modal-header-bg {
    background: linear-gradient(135deg, #330066 0%, #4c0099 100%);
    border-bottom: 3px solid #B266FF;
}

.edit-link {
    position: absolute;
    right: 32px; /* Positioned to the left of the delete button */
    top: 50%;
    transform: translateY(-50%);
    opacity: 0;
    transition: 0.2s;
}

.link-pill:hover .edit-link {
    opacity: 1;
}

#date-jumper::-webkit-calendar-picker-indicator {
    cursor: pointer;
}

/* Optional: Make the Today/Jump group look like a single unit */
.rounded-l-full { border-top-right-radius: 0; border-bottom-right-radius: 0; }
.rounded-r-full { border-top-left-radius: 0; border-bottom-left-radius: 0; }

#master-progress-fill {
    height: 100%;
    transition: width 0.5s ease, background-color 0.5s ease; /* Added background-color transition */
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
.animate-spin {
    animation: spin 1s linear infinite;
}

.confetti-piece {
        position: fixed;
        top: -10px;
        width: 10px;
        height: 10px;
        z-index: 9999;
        pointer-events: none;
        animation: fall linear forwards;
    }

    @keyframes fall {
        to {
            transform: translateY(105vh) rotate(360deg);
        }
    }
    
    @keyframes successPop {
        0% { transform: scale(1); }
        50% { transform: scale(1.25); }
        100% { transform: scale(1.1); }
    }
    .success-pop {
        animation: successPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
/* Animation for search results filtering */
    #notes-list-wrapper details.hidden {
        display: none;
    }
    #notes-list-wrapper details:not(.hidden) {
        animation: fadeIn 0.2s ease-out;
    }
.material-card {
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    overflow: hidden;
    height: fit-content;
}
.nested-topic {
    margin-left: 1.5rem;
    border-left: 2px dashed #f3e8ff;
    padding-left: 0.75rem;
}
.trackable-item:hover {
    background-color: #f9fafb;
}

/* Material Tracker Specifics */
#materials-grid > div:last-child:nth-child(odd) {
    grid-column: 1 / -1; /* This forces any "last odd" item to span the full width */
}

@media (min-width: 768px) {
    #materials-grid > div:last-child:nth-child(odd) {
        grid-column: span 2; /* Stretches the 1st, 3rd, 5th, etc. if it's the last one */
    }
}

.material-panel {
    border-top: 4px solid var(--panel-color, #B266FF);
    transition: transform 0.2s;
}
.material-panel:hover {
    transform: translateY(-2px);
}
.nested-topic {
    margin-left: 1.25rem;
    border-left: 1px dashed #e5e7eb;
    padding-left: 0.75rem;
}
.subject-progress-container {
    background: rgba(0, 0, 0, 0.05);
    height: 6px;
    border-radius: 999px;
    overflow: hidden;
    margin-top: 4px;
}
.subject-progress-fill {
    height: 100%;
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

</style>
</head>

<body class="bg-gray-100 min-h-screen p-1 sm:p-2">
    
<div id="auth-overlay" class="fixed inset-0 z-[9999] bg-gray-100 hidden flex-col items-center transition-opacity duration-500"></div>

        <header class="header-bg text-white py-1 px-4 sm:py-2 sm:px-6 rounded-xl shadow-2xl mt-1">
            <div class="flex items-center justify-between">
                <div class="flex-shrink-0 w-24 h-24 flex items-center justify-center rounded-full overflow-hidden">
                    <img src="https://raw.githubusercontent.com/ariiannemay/2026-Bar-Exam-Tracker/main/Images/LAWLOGO.png" alt="Law Logo" class="w-24 h-24 object-cover">
                </div>
                <div class="text-center mx-4 flex-grow">
                    <h1 class="text-3xl sm:text-4xl italic font-extrabold header-font tracking-widest mb-1" style="text-shadow: 2px 2px 0 #000000;">2026 BAR EXAM REVIEW TRACKER</h1>
                    <h2 class="text-xl sm:text-xl font-extrabold tracking-wider mb-0 italic" style="line-height: 1.1;">#AweSAMBar2026</h2>
                </div>
                <div class="flex-shrink-0 w-24 h-24 flex items-center justify-center rounded-full overflow-hidden">
                    <img src="https://raw.githubusercontent.com/ariiannemay/2026-Bar-Exam-Tracker/main/Images/CHECKLIST.png" alt="Checklist Logo" class="w-24 h-24 object-cover">
                </div>
            </div>
        </header>

<nav class="flex bg-white rounded-b-xl shadow-md border-x border-b border-gray-200 p-0.5 gap-1 mb-6">
            <button onclick="switchTab('tab-materials')" class="tab-btn active flex-1 py-1 px-4 rounded-md text-gray-500 font-bold uppercase flex items-center justify-center gap-2" id="btn-materials">
                <i data-lucide="book-open-check" class="w-4 h-4"></i> <span>Materials Tracker</span>
            </button>
            <button onclick="switchTab('tab-todo')" class="tab-btn flex-1 py-1 px-4 rounded-md text-gray-500 font-bold uppercase flex items-center justify-center gap-2" id="btn-todo">
                <i data-lucide="list-checks" class="w-4 h-4"></i> <span>To-Do List</span>
            </button>
            <button onclick="switchTab('tab-notes')" class="tab-btn flex-1 py-1 px-4 rounded-md text-gray-500 font-bold uppercase flex items-center justify-center gap-2" id="btn-notes">
                <i data-lucide="notebook" class="w-4 h-4"></i> <span>Review Notes</span>
            </button>
            <button onclick="switchTab('tab-links')" class="tab-btn flex-1 py-1 px-4 rounded-md text-gray-500 font-bold uppercase flex items-center justify-center gap-2" id="btn-links">
                <i data-lucide="external-link" class="w-4 h-4"></i> <span>Links</span>
            </button>
        </nav>

        <div id="tab-notes" class="tab-content">
            <div class="bg-white p-4 rounded-xl shadow border border-gray-200">


<div class="header-bg px-5 py-4 rounded-xl shadow-lg border-b-4 border-[#B266FF] mb-6">
    <div class="flex justify-between items-center mb-1">
        <h2 class="header-font text-xl text-white tracking-widest uppercase">Overall Notes Progress</h2>
<span id="master-percent-text" class="font-black text-sm text-white">0%</span>
    </div>

    <div id="master-progress-wrapper" class="bg-white/10 h-1 rounded-full overflow-hidden mt-2 mb-3">
        <div id="master-progress-fill" class="h-full bg-white shadow-[0_0_8px_#B266FF] transition-all duration-700 w-0"></div>
    </div>

    <div class="relative group">
        <i data-lucide="search" class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3 h-3 text-white/40 group-focus-within:text-white transition-colors"></i>
        <input type="text" id="syllabus-search" placeholder="Search topics..." 
               class="w-full pl-8 pr-3 py-1.5 bg-white/10 border border-white/10 rounded-lg outline-none focus:bg-white/20 transition-all text-[10px] text-white placeholder:text-white/30 font-medium"
               oninput="handleSyllabusSearch(this.value)">
    </div>
</div>


<div class="w-full mb-6 border-b pb-4" id="subject-tabs">
    <button onclick="switchSubject('rem')" class="sub-tab-btn" id="sub-btn-rem" data-sub="rem">Remedial Law</button>
    <button onclick="switchSubject('crim')" class="sub-tab-btn" id="sub-btn-crim" data-sub="crim">Criminal Law</button>
    <button onclick="switchSubject('lab')" class="sub-tab-btn" id="sub-btn-lab" data-sub="lab">Labor Law</button>
    <button onclick="switchSubject('civ')" class="sub-tab-btn" id="sub-btn-civ" data-sub="civ">Civil Law</button>
    <button onclick="switchSubject('tax')" class="sub-tab-btn" id="sub-btn-tax" data-sub="tax">Commercial Law</button>
    <button onclick="switchSubject('poli')" class="sub-tab-btn active" id="sub-btn-poli" data-sub="poli">Political Law</button>
</div>

                <div id="subject-notes-container" class="space-y-4"></div>
            </div>
        </div>

<div id="tab-materials" class="tab-content">
    <div class="header-bg p-4 rounded-t-xl flex justify-between items-center">
        <div class="flex flex-col">
            <h2 class="header-font text-2xl text-white tracking-widest uppercase leading-none">Materials Tracker</h2>
            <p class="text-[10px] font-bold text-white/60 italic tracking-widest mt-1 uppercase">
                Use this to track progress for review books, video lectures, or handouts
            </p>
        </div>
        <button onclick="openMaterialModal()" class="bg-[#B266FF] text-white px-4 py-2 rounded-lg font-black text-[10px] uppercase hover:scale-105 transition-all">
            + Track a Review Material
        </button>
    </div>
    
    <div id="materials-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 p-4"></div>
</div>

<div id="topic-entry-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[260] p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden modal-animate-in">
        <div class="modal-header-bg p-4 text-white font-black header-font text-xl tracking-widest uppercase">
            Add Topic
        </div>
        <div class="p-6 space-y-4">
            <input type="text" id="topic-title" placeholder="Topic Title..." class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none focus:border-[#B266FF]">
            <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl cursor-pointer">
                <input type="checkbox" id="topic-trackable" class="w-5 h-5 rounded border-gray-300 text-[#330066]">
                <span class="text-xs font-bold text-gray-600 uppercase">Make Trackable (Add Checkbox)</span>
            </label>
        </div>
        <div class="p-4 bg-gray-50 flex gap-2">
            <button onclick="closeTopicModal()" class="flex-1 py-3 text-gray-400 font-black uppercase text-[10px]">Cancel</button>
            <button id="save-topic-btn" class="flex-1 py-3 bg-[#330066] text-white font-black uppercase text-[10px] rounded-xl shadow-lg">Save Topic</button>
        </div>
    </div>
</div>

<div id="material-entry-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[250] p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden modal-animate-in">
        <div class="modal-header-bg p-4 text-white font-black header-font text-2xl tracking-widest uppercase flex justify-between">
            <span id="mat-modal-title">New Review Material</span>
            <button onclick="closeMaterialModal()"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="p-8 space-y-6">
            <input type="text" id="mat-name" placeholder="Material Name (e.g. Leonen Civ Notes)" class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none focus:border-[#B266FF]">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <label class="block text-[10px] font-black uppercase text-gray-400 mb-3">Select Icon</label>
                    <div id="mat-icon-picker" class="grid grid-cols-5 gap-1 p-2 border border-gray-100 rounded-xl bg-gray-50/30"></div>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-gray-400 mb-3">Select Color</label>
                    <div id="mat-color-picker" class="grid grid-cols-5 gap-3 p-1"></div>
                </div>
            </div>
        </div>
        <div class="p-6 bg-gray-50 flex gap-3">
            <button onclick="closeMaterialModal()" class="flex-1 py-3 text-gray-400 font-black uppercase text-[10px] tracking-widest hover:text-gray-600 transition-colors">Cancel</button>
            <button onclick="saveMaterialEntry()" class="flex-1 py-3 bg-[#330066] text-white font-black uppercase text-[10px] tracking-widest rounded-xl shadow-lg hover:bg-[#B266FF] transition-all">Save Material</button>
        </div>
    </div>
</div>



        <div id="tab-todo" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden flex flex-col min-h-[700px]">
                <div class="header-bg p-4 flex flex-col md:flex-row justify-between items-center gap-4">
<div class="flex items-center gap-4">
    <button onclick="navigateTodo(-1)" class="p-2 hover:bg-white/10 rounded-full text-white">
        <i data-lucide="chevron-left"></i>
    </button>
    <div class="text-white text-center md:text-left min-w-[180px]">
        <h2 id="todo-view-title" class="header-font text-2xl tracking-widest uppercase">Agenda</h2>
        <p id="todo-date-display" class="text-[10px] font-bold uppercase opacity-80"></p>
    </div>
    <button onclick="navigateTodo(1)" class="p-2 hover:bg-white/10 rounded-full text-white">
        <i data-lucide="chevron-right"></i>
    </button>
    
    <div class="flex items-center ml-2 bg-[#B266FF] rounded-lg overflow-hidden border border-white/20 shadow-sm">
        <button onclick="jumpToToday()" class="px-3 py-1.5 text-[10px] font-black uppercase text-white hover:bg-white hover:text-[#330066] transition-all border-r border-white/20">
            Today
        </button>
        <button onclick="document.getElementById('date-jumper').showPicker()" class="px-3 py-1.5 text-white hover:bg-white hover:text-[#330066] transition-all flex items-center justify-center">
            <i data-lucide="calendar" class="w-3.5 h-3.5"></i>
        </button>
        <input type="date" id="date-jumper" class="absolute invisible" onchange="handleJumpToDate(this.value)">
    </div>
</div>


                    <div class="flex bg-white/10 p-1 rounded-lg gap-1">
                        <button onclick="switchTodoMode('daily')" id="todo-btn-daily" class="todo-mode-btn px-4 py-1 text-[10px] font-black uppercase rounded bg-white text-[#330066]">Daily</button>
                        <button onclick="switchTodoMode('weekly')" id="todo-btn-weekly" class="todo-mode-btn px-4 py-1 text-[10px] font-black uppercase rounded text-white">Weekly</button>
                    </div>
                </div>

                <div id="todo-render-container" class="p-6 flex-grow todo-paper overflow-x-auto"></div>
            </div>
        </div>



<div id="tab-links" class="tab-content">

<div class="header-bg p-4 rounded-lg mb-6 flex justify-between items-center">
    <div class="flex flex-col">
        <h2 class="header-font text-2xl text-white tracking-widest uppercase leading-none">Resource Links</h2>
        <p class="text-[10px] font-bold text-white/60 italic tracking-widest mt-1 uppercase">
            Centralized database for drive links, lectures, and online reviewers
        </p>
    </div>
    <button onclick="toggleLinkModal(true)" class="bg-[#B266FF] text-white px-4 py-2 rounded-lg font-black text-[10px] uppercase hover:scale-105 transition-all">
        + Add New Link
    </button>
</div>

        <div id="links-grid" class="grid grid-cols-2 gap-3">
            </div>
    </div>
</div>

<div id="link-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[250] p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden modal-animate-in">
        <div class="modal-header-bg p-4 text-white font-black header-font text-2xl tracking-widest uppercase flex justify-between">
            <span id="link-modal-title">Add Resource Link</span>
            <button onclick="toggleLinkModal(false)"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="p-8 space-y-6">
            <div class="space-y-4">
                <input type="text" id="link-title" placeholder="Link Title (e.g. Civ Law Drive)" class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none focus:border-[#B266FF]">
                <input type="text" id="link-url" placeholder="URL (https://...)" class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none focus:border-[#B266FF]">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <label class="block text-[10px] font-black uppercase text-gray-400 mb-3 tracking-widest">Select Icon</label>
                    <div id="icon-picker" class="grid grid-cols-5 gap-1 p-2 border border-gray-100 rounded-xl bg-gray-50/30"></div>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-gray-400 mb-3 tracking-widest">Select Color</label>
<div id="color-picker" class="grid grid-cols-5 gap-3 p-1"></div>
                </div>
            </div>
        </div>
        <div class="p-6 bg-gray-50 flex gap-3">
            <button onclick="toggleLinkModal(false)" class="flex-1 py-3 text-gray-400 font-black uppercase text-[10px] tracking-widest">Cancel</button>
            <button onclick="saveLink()" class="flex-1 py-3 bg-[#330066] text-white font-black uppercase text-[10px] tracking-widest rounded-xl shadow-lg">Save Link</button>
        </div>
    </div>
</div>

    <script>
        lucide.createIcons();

        // --- REVIEW NOTES LOGIC ---
const SUBJECTS = {
    poli: typeof POLI_SYLLABUS !== 'undefined' ? POLI_SYLLABUS : [],
    lab: typeof LAB_SYLLABUS !== 'undefined' ? LAB_SYLLABUS : [],
    civ: typeof CIV_SYLLABUS !== 'undefined' ? CIV_SYLLABUS : [],
    tax: typeof COMM_TAX_SYLLABUS !== 'undefined' ? COMM_TAX_SYLLABUS : [],
    crim: typeof CRIM_SYLLABUS !== 'undefined' ? CRIM_SYLLABUS : [],
    rem: typeof REM_ETHICS_SYLLABUS !== 'undefined' ? REM_ETHICS_SYLLABUS : []
};

function switchTab(tabId) {
    // 1. Remove active state from all content and buttons
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    // 2. Add active state to the selected tab and its corresponding nav button
    document.getElementById(tabId).classList.add('active');
    const btnId = 'btn-' + tabId.split('-')[1];
    const targetBtn = document.getElementById(btnId);
    if (targetBtn) targetBtn.classList.add('active');
    
    // 3. Trigger specific renderers based on the tab
    if (tabId === 'tab-todo') renderTodoView();
    if (tabId === 'tab-links') renderLinks();
    if (tabId === 'tab-materials') renderMaterials();
    
    // 4. Special handling for Review Notes tab
    if (tabId === 'tab-notes') {
        const container = document.getElementById('subject-notes-container');
        // Only trigger a subject switch if the container is currently empty
        if (!container.innerHTML.trim() || container.innerHTML.includes('loader-2')) {
            switchSubject('rem'); 
        }
    }
}

const loadedScripts = new Set();

function lazyLoadSubject(sub, callback) {
    if (loadedScripts.has(sub)) {
        callback();
        return;
    }

    // Show the spinner in the container while waiting
    const container = document.getElementById('subject-notes-container');
    if (container) {
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center py-20 text-[#B266FF]">
                <i data-lucide="loader-2" class="w-10 h-10 animate-spin mb-4"></i>
                <span class="header-font text-sm tracking-widest uppercase opacity-70">Loading Syllabus...</span>
            </div>
        `;
        lucide.createIcons();
    }

    const scriptMap = {
        poli: 'poli_logic.js',
        lab: 'lab_logic.js',
        civ: 'civ_logic.js',
        tax: 'comm_logic.js',
        crim: 'crim_logic.js',
        rem: 'rem_logic.js'
    };

    const script = document.createElement('script');
    script.src = scriptMap[sub];
    script.onload = () => {
        const syllabusMap = {
            poli: typeof POLI_SYLLABUS !== 'undefined' ? POLI_SYLLABUS : [],
            lab: typeof LAB_SYLLABUS !== 'undefined' ? LAB_SYLLABUS : [],
            civ: typeof CIV_SYLLABUS !== 'undefined' ? CIV_SYLLABUS : [],
            tax: typeof COMM_TAX_SYLLABUS !== 'undefined' ? COMM_TAX_SYLLABUS : [],
            crim: typeof CRIM_SYLLABUS !== 'undefined' ? CRIM_SYLLABUS : [],
            rem: typeof REM_ETHICS_SYLLABUS !== 'undefined' ? REM_ETHICS_SYLLABUS : []
        };
        SUBJECTS[sub] = syllabusMap[sub];
        loadedScripts.add(sub);
        callback();
    };
    document.head.appendChild(script);
}

function switchSubject(sub) {
    const searchInput = document.getElementById('syllabus-search');
    if (searchInput) searchInput.value = '';
    document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
    const activeBtn = document.getElementById('sub-btn-' + sub);
    if (activeBtn) activeBtn.classList.add('active');

    lazyLoadSubject(sub, () => {
        const container = document.getElementById('subject-notes-container');
        const syllabus = SUBJECTS[sub];
        if (!container || !syllabus) return;

        const subjectTitle = activeBtn.innerText.split('(')[0].trim();
        const activeColor = getActiveThemeColor(sub);
        
        // Map specific icons based on subject name
        const iconMap = { poli: 'landmark', lab: 'handshake', civ: 'building-2', tax: 'banknote', crim: 'shield', rem: 'gavel' };
        const icon = iconMap[sub] || 'book';

        // Calculate Stats for the Header
        let total = 0, done = 0;
        syllabus.forEach((item, index) => {
            if (item.depth === 2) {
                total++;
                const parent = syllabus.slice(0, index).reverse().find(i => i.depth === 1);
                if (localStorage.getItem(`note_${sub}_${parent ? parent.topic : ''}_${item.topic}`)?.trim()) done++;
            }
        });
        const percent = total === 0 ? 0 : Math.round((done / total) * 100);

// Premium Subject Header themed after the Materials Tracker
const isTax = sub === 'tax'; // Commercial Law check
const textColor = isTax ? '#000000' : '#FFFFFF'; 
const mutedColor = isTax ? 'rgba(51, 0, 102, 0.6)' : 'rgba(255, 255, 255, 0.6)';
const btnBg = isTax ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.2)';

container.innerHTML = `
    <div class="rounded-xl overflow-hidden mb-6 shadow-md border border-gray-100 transition-all duration-500">
        <div class="p-5 flex flex-col gap-4" style="background-color: ${activeColor}">
            <div class="flex justify-between items-center" style="color: ${textColor}">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl flex items-center justify-center bg-black/10 shadow-inner">
                        <i data-lucide="${icon}" class="w-6 h-6" style="color: ${textColor}"></i>
                    </div>
                    <div>
                        <h3 class="font-black uppercase text-lg tracking-widest leading-tight">
                            ${subjectTitle}
                        </h3>
                        <p class="text-[10px] font-bold italic tracking-widest uppercase" style="color: ${mutedColor}">
                            Official Syllabus Review Notes â€¢ #AweSAMBar2026
                        </p>
                    </div>
                </div>
                <button onclick="exportSubjectNotes('${sub}')" 
                    class="text-[10px] font-black border px-4 py-2 rounded-xl transition-all shadow-sm"
                    style="background-color: ${btnBg}; color: ${textColor}; border-color: ${mutedColor}">
                    EXPORT PDF
                </button>
            </div>
            
            <div class="flex flex-wrap items-center gap-6 px-1" style="color: ${textColor}">
                <div class="flex items-center gap-2">
                    <i data-lucide="check-circle" class="w-4 h-4" style="opacity: 0.8"></i>
                    <span class="text-[10px] font-black uppercase tracking-tighter">FINISHED: ${done} TOPICS</span>
                </div>
                <div class="flex items-center gap-2">
                    <i data-lucide="book-open" class="w-4 h-4" style="opacity: 0.8"></i>
                    <span class="text-[10px] font-black uppercase tracking-tighter">REMAINING: ${total - done}</span>
                </div>
                <div class="flex-grow flex items-center gap-4">
                    <span class="text-[10px] font-black uppercase tracking-tighter">PROGRESS:</span>
                    <div class="flex-grow h-2.5 bg-black/10 rounded-full overflow-hidden border border-black/5 shadow-inner">
                        <div class="h-full bg-white transition-all duration-700 ease-out" style="width: ${percent}%"></div>
                    </div>
                    <span class="text-[10px] font-black">${percent}%</span>
                </div>
            </div>
        </div>
    </div>


    <div id="notes-list-wrapper"></div>`;
        // Render the actual syllabus list below the header
        const listWrapper = document.getElementById('notes-list-wrapper');
        syllabus.forEach((item, index) => {
            if (item.depth === 1) {
                listWrapper.innerHTML += `
                    <details class="group bg-white rounded-xl border border-gray-200 overflow-hidden mb-3 shadow-sm" onclick="renderSubTopics(this, '${sub}', ${index})">
                        <summary class="p-4 font-black text-sm text-[#330066] cursor-pointer hover:bg-gray-50 flex justify-between items-center select-none border-l-4" style="border-color: ${activeColor}">
                            <span class="uppercase tracking-wider">${item.topic}</span>
                            <i data-lucide="chevron-down" class="w-4 h-4 transition-transform group-open:rotate-180 opacity-40"></i>
                        </summary>
                        <div class="p-2 bg-gray-50/30 sub-content-area"><div class="flex justify-center py-4"><i data-lucide="loader-2" class="animate-spin text-purple-300"></i></div></div>
                    </details>`;
            }
        });
        lucide.createIcons();
        updateProgress();
    });
}

function renderSubTopics(detailsElement, sub, startIndex) {
    const contentArea = detailsElement.querySelector('.sub-content-area');
    if (contentArea.dataset.loaded === "true") return;

    const syllabus = SUBJECTS[sub];
    const fragment = document.createDocumentFragment();
    let i = startIndex + 1;

    while (i < syllabus.length && syllabus[i].depth > 1) {
        const item = syllabus[i];
        const parent = syllabus.slice(0, i).reverse().find(s => s.depth === 1);
        const storageKey = `note_${sub}_${parent ? parent.topic : ''}_${item.topic}`;
        
        const div = document.createElement('div');
        div.className = "bg-white p-4 rounded-lg border border-purple-100 shadow-inner mb-3 ml-4";
        div.innerHTML = `
            <label class="block text-[10px] font-black text-[#B266FF] uppercase mb-2 tracking-widest">${item.topic}</label>
            <textarea class="auto-expand w-full bg-transparent border-none outline-none resize-none overflow-hidden text-[13px]" 
                      placeholder="Take notes..."
                      oninput="autoExpand(this); saveNoteRecursive('${storageKey}', this.value); updateProgress()"
            >${localStorage.getItem(storageKey) || ''}</textarea>`;
        fragment.appendChild(div);
        i++;
    }

    contentArea.innerHTML = '';
    contentArea.appendChild(fragment);
    contentArea.dataset.loaded = "true";
    
    setTimeout(() => {
        contentArea.querySelectorAll('textarea').forEach(autoExpand);
        lucide.createIcons();
    }, 10);
}

// Global helper for the recursion
function saveNoteRecursive(key, val) {
    localStorage.setItem(key, val);
}


function updateProgress() {
    let totalSubtopics = 0;
    let completedSubtopics = 0;

    Object.keys(SUBJECTS).forEach(sub => {
        const syllabus = SUBJECTS[sub];
        if (!syllabus.length) return;
        
        let subCount = 0;
        let subDone = 0;

        syllabus.forEach((item, index) => {
            if (item.depth === 2) {
                totalSubtopics++;
                subCount++;
                const parent = syllabus.slice(0, index).reverse().find(i => i.depth === 1);
                // Topic is DONE only if note exists and is not just whitespace
                const savedContent = localStorage.getItem(`note_${sub}_${parent ? parent.topic : ''}_${item.topic}`);
                if (savedContent && savedContent.trim().length > 0) {
                    completedSubtopics++;
                    subDone++;
                }
            }
        });

        const percent = Math.round((subDone / subCount) * 100) || 0;
const btn = document.getElementById('sub-btn-' + sub);
if (btn) {
    // This regex removes any existing "(0%)" or " (0%)" pattern from the name
    const rawName = btn.getAttribute('data-name') || btn.innerText.split('(')[0].trim();
    const cleanName = rawName.replace(/\s*\(\d+%\)\s*/g, "").trim();
    
    btn.setAttribute('data-name', cleanName);
    btn.innerHTML = `
        <div class="flex flex-col items-center gap-1">
            <span class="font-black text-[10px] tracking-tighter">${cleanName}</span>
            <div class="w-full bg-gray-200 h-1 rounded-full overflow-hidden">
                <div class="h-full" style="width: ${percent}%; background-color: ${getActiveThemeColor(sub)}"></div>
            </div>
            <span class="text-[8px] font-bold opacity-60">${percent}%</span>
        </div>
    `;
}
    });

    // Update Master Progress Bar UI
const totalPercent = Math.round((completedSubtopics / totalSubtopics) * 100) || 0;
    const fill = document.getElementById('master-progress-fill');
    const text = document.getElementById('master-percent-text');
    
    if (fill) {
        fill.style.width = totalPercent + '%';
        
        // Dynamic Color Logic: Red -> Orange -> Yellow -> Green
        let progressColor = '#ef4444'; // Default Red (0-25%)
        if (totalPercent > 25 && totalPercent <= 50) progressColor = '#f97316'; // Orange
        if (totalPercent > 50 && totalPercent <= 75) progressColor = '#eab308'; // Yellow
        if (totalPercent > 75) progressColor = '#22c55e'; // Green
        
        fill.style.background = progressColor;
    }
    
    if (text) {
        text.innerText = totalPercent + '%';
        if (totalPercent > 25) text.style.color = fill.style.background;
    }
}


function getActiveThemeColor(sub) {
    const colors = { poli: '#795548', civ: '#1e3a8a', rem: '#674ea7', lab: '#38761d', tax: '#eab308', crim: '#b33a3a' };
    return colors[sub] || '#330066';
}

function saveNote(sub, mainTopic, subTopic, val) {
    localStorage.setItem(`note_${sub}_${mainTopic}_${subTopic}`, val);
}

        function autoExpand(textarea) {
            textarea.style.height = 'inherit';
            textarea.style.height = textarea.scrollHeight + 'px';
        }


        // --- TO-DO LOGIC ---
        let todoMode = 'daily';
        let todoOffset = 0; 

        // Storage structure: { "date_string": [{text: "...", done: false}] }
        let todoStorage = JSON.parse(localStorage.getItem('bar_todos_v2')) || {};

function switchTodoMode(mode) {
    todoMode = mode;
    document.querySelectorAll('.todo-mode-btn').forEach(b => {
        b.classList.remove('selected-active', 'bg-white', 'text-[#330066]'); // Clear all possible active states
        b.classList.add('text-white'); // Reset to default white text
    });
const activeBtn = document.getElementById(`todo-btn-${mode}`);
    if(activeBtn) {
        activeBtn.classList.add('selected-active');
        activeBtn.classList.remove('text-white');
    }
    renderTodoView();
}

function navigateTodo(dir) {
    const jumpAmount = (todoMode === 'weekly') ? 7 : 1;
    todoOffset += (dir * jumpAmount);
    renderTodoView();
}

        function jumpToToday() {
            todoOffset = 0;
            renderTodoView();
        }

window.jumpToSpecificDate = function(dateString) {
    // If the string contains a dash (YYYY-MM-DD), it's from the date picker
    // If it's a long string like "Tue Dec 30 2025", it's from the mini-calendar
    const useTimestamp = dateString.includes('-') ? dateString + "T00:00:00" : dateString;
    
    const targetDate = new Date(useTimestamp);
    const today = new Date();
    
    // Normalize both to midnight for perfect math
    today.setHours(0, 0, 0, 0);
    targetDate.setHours(0, 0, 0, 0);
    
    // Check if the date is valid before updating
    if (isNaN(targetDate.getTime())) {
        console.error("Attempted to jump to an invalid date:", dateString);
        return;
    }
    
    const diffTime = targetDate.getTime() - today.getTime();
    todoOffset = Math.round(diffTime / (1000 * 60 * 60 * 24));
    
    renderTodoView();
};

function handleJumpToDate(val) {
    if (!val) return;
    
    // Simply pass the value to our universal jumper logic
    window.jumpToSpecificDate(val);
    
    // Reset picker UI
    document.getElementById('date-jumper').value = '';
}


function renderTodoView() {
    const container = document.getElementById('todo-render-container');
    const title = document.getElementById('todo-view-title');
    const dateDisplay = document.getElementById('todo-date-display');
    const baseDate = new Date();
    const viewingDate = new Date(baseDate);
    viewingDate.setDate(viewingDate.getDate() + todoOffset);

const dateKey = viewingDate.toDateString();
    const tasks = todoStorage[dateKey] || [];

if (todoMode === 'daily') {
        title.innerText = "DAILY TASKS";
        dateDisplay.innerText = viewingDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        
        let calendarHtml = '<div class="mini-calendar-sidebar">';
        for (let i = -1; i <= 1; i++) {
            const calDate = new Date(viewingDate.getFullYear(), viewingDate.getMonth() + i, 1);
            calendarHtml += generateMiniCal(calDate, viewingDate);
        }
        calendarHtml += '</div>';

container.innerHTML = `
            <div class="daily-layout-grid">
                <div class="space-y-4">
                    <div class="flex items-center gap-2">
                        <button onclick="addTodoItem('${dateKey}')" class="flex-grow text-sm font-black text-[#B266FF] border-2 border-dashed border-[#B266FF]/30 px-6 py-2 rounded-xl uppercase flex items-center justify-center gap-2 hover:bg-[#B266FF] hover:text-white transition-all">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> ADD A TASK
                        </button>
                        ${tasks.length > 0 ? `<button onclick="clearDayTasks('${dateKey}')" class="clear-all-btn whitespace-nowrap px-4 py-2 h-full rounded-xl border-2">Clear All</button>` : ''}
                    </div>
                    <div id="list-${dateKey}">${renderTaskList(dateKey, 'large')}</div>
                </div>
                ${calendarHtml}
            </div>`;
} else {
        title.innerText = "WEEKLY TASKS";
        const baseDate = new Date();
        const viewingDate = new Date(baseDate);
        viewingDate.setDate(viewingDate.getDate() + todoOffset);
        
        const startOfWeek = new Date(viewingDate);
        startOfWeek.setDate(viewingDate.getDate() - viewingDate.getDay());
        
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        
        const options = { month: 'long', day: 'numeric', year: 'numeric' };
        dateDisplay.innerText = `${startOfWeek.toLocaleDateString('en-US', options)} - ${endOfWeek.toLocaleDateString('en-US', options)}`;

        // DEFINE THE SIDEBAR CALENDARS FIRST
        let calendarSidebarHtml = '<div class="flex flex-col gap-4">';
        for (let i = -1; i <= 1; i++) {
            const calDate = new Date(viewingDate.getFullYear(), viewingDate.getMonth() + i, 1);
            calendarSidebarHtml += generateMiniCal(calDate, viewingDate);
        }
        calendarSidebarHtml += '</div>';

// BUILD THE 7-DAY CARDS
        let daysHtml = '';
        for (let i = 0; i < 7; i++) {
            const dayDate = new Date(startOfWeek);
            dayDate.setDate(startOfWeek.getDate() + i);
            const dateKey = dayDate.toDateString();
            
            // Fix: Filter out empty placeholder tasks for the counter
            const tasks = (todoStorage[dateKey] || []).filter(t => t.text.trim() !== "");
            const totalTasks = tasks.length;
            const doneTasks = tasks.filter(t => t.done).length;
            
            const isFinished = totalTasks > 0 && doneTasks === totalTasks;
            const progressText = `${doneTasks}/${totalTasks} DONE`;

            const colFullDate = dayDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            const isSaturday = dayDate.getDay() === 6;
            const spanClass = isSaturday ? 'saturday-span' : '';
    
            // Dynamic badge color and animation
            const badgeClass = isFinished 
                ? 'bg-green-500 text-white border-green-600 scale-110 shadow-lg success-pop' 
                : 'bg-purple-50 text-[#B266FF] border-purple-100';

            daysHtml += `
                <div class="weekly-day-card ${spanClass}">
                    <div class="flex items-start justify-between border-b-2 border-[#B266FF] mb-3 pb-2">
                        <div>
                            <span class="block font-black text-[#330066] text-sm uppercase tracking-widest">${dayDate.toLocaleDateString('en-US', {weekday:'long'})}</span>
                            <span class="block text-[10px] text-gray-400 font-bold uppercase">${colFullDate}</span>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="text-[9px] font-black px-2 py-0.5 rounded-full border uppercase tracking-tighter transition-all duration-300 ${badgeClass}">
                                ${progressText}
                            </span>
                        </div>
                    </div>
                    
                    <div class="flex gap-1 w-full mb-3">
                        <button onclick="addTodoItem('${dateKey}')" class="add-task-btn-thin flex-grow border border-dashed border-purple-200 rounded py-1 text-[9px] font-bold text-[#B266FF] uppercase hover:bg-purple-50 transition-all">
                            + Add Task
                        </button>
                    </div>

                    <div id="list-${dateKey}" class="w-full space-y-1">${renderTaskList(dateKey, 'small')}</div>
                </div>`;
        }

        // RENDER EVERYTHING
        container.innerHTML = `
            <div class="weekly-planner-grid">
                <div class="weekly-tasks-stack">
                    ${daysHtml}
                </div>
                <div class="mini-calendar-sidebar">
                    ${calendarSidebarHtml}
                </div>
            </div>`;
    } // This bracket safely closes the "else" logic

    // Refresh everything
    lucide.createIcons();
    document.querySelectorAll('.task-row textarea').forEach(el => autoExpand(el));
}

function clearDayTasks(dateKey) {
    // Replaced browser confirm with the themed modal
    showThemedConfirm(
        "Clear Agenda", 
        "Are you sure you want to delete all tasks for this day? This action cannot be undone.", 
        () => {
            todoStorage[dateKey] = [];
            saveAndRefresh();
        }
    );
}

function generateMiniCal(monthDate, selectedDate) {
    const monthName = monthDate.toLocaleString('default', { month: 'long', year: 'numeric' });
    const firstDay = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1).getDay();
    const daysInMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();
    const today = new Date();

    let html = `
        <div class="mini-cal">
            <div class="mini-cal-header">${monthName}</div>
            <div class="mini-cal-grid">
                <div class="mini-cal-day-label">S</div><div class="mini-cal-day-label">M</div>
                <div class="mini-cal-day-label">T</div><div class="mini-cal-day-label">W</div>
                <div class="mini-cal-day-label">T</div><div class="mini-cal-day-label">F</div>
                <div class="mini-cal-day-label">S</div>`;

    for (let i = 0; i < firstDay; i++) html += '<div></div>';

    // UPDATED DATE GENERATION:
    for (let day = 1; day <= daysInMonth; day++) {
        const checkDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), day);
        const dateKey = checkDate.toDateString();
        let classes = "mini-cal-date";
        
        if (dateKey === new Date().toDateString()) classes += " mini-cal-today";
        if (dateKey === selectedDate.toDateString()) classes += " mini-cal-viewing";
        
        // Added onclick to jump to date
        html += `<div class="${classes}" onclick="jumpToSpecificDate('${dateKey}')">${day}</div>`;
    }
    html += `</div></div>`;
    return html;
}

function renderTaskList(dateKey, sizeClass) {
    let tasks = todoStorage[dateKey] || [];
    
// If truly empty, return empty string so the card just shows the "Add Task" button
    if (tasks.length === 0) return '';

    const inputClass = sizeClass === 'large' ? 'task-input-large' : 'task-input-small';
    const iconSize = sizeClass === 'large' ? 'w-5 h-5' : 'w-3.5 h-3.5';

    return tasks.map((task, i) => `
        <div class="task-row group">
            <input type="checkbox" 
                   onchange="toggleTodo('${dateKey}', ${i})" 
                   ${task.done ? 'checked' : ''} 
                   class="w-5 h-5 rounded border-gray-300 text-[#330066] flex-shrink-0">
            
            <textarea rows="1" 
                      oninput="autoExpand(this); editTodo('${dateKey}', ${i}, this.value)" 
                      class="bg-transparent border-none outline-none flex-grow ${inputClass} ${task.done ? 'line-through text-gray-300' : 'text-gray-700'} resize-none overflow-hidden"
                      placeholder="Enter task..."
            >${task.text}</textarea>
            
            <div class="task-actions">
                <button onclick="removeTodo('${dateKey}', ${i})" class="text-red-400 hover:text-red-600 transition-colors">
                    <i data-lucide="trash-2" class="${iconSize}"></i>
                </button>
            </div>
        </div>
    `).join('');
}

        function addTodoItem(dateKey) {
            if (!todoStorage[dateKey]) todoStorage[dateKey] = [];
            todoStorage[dateKey].push({ text: 'New Task', done: false });
            saveAndRefresh();
        }

function toggleTodo(dateKey, i) { 
            todoStorage[dateKey][i].done = !todoStorage[dateKey][i].done; 
            
            // Check for confetti trigger
            const tasks = (todoStorage[dateKey] || []).filter(t => t.text.trim() !== "");
            const totalTasks = tasks.length;
            const doneTasks = tasks.filter(t => t.done).length;

            if (totalTasks > 0 && doneTasks === totalTasks && todoStorage[dateKey][i].done) {
                createConfetti();
            }
            
            saveAndRefresh(); 
        }

        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = ['#B266FF', '#330066', '#FFD700', '#22c55e'][Math.floor(Math.random() * 4)];
                confetti.style.animationDuration = (Math.random() * 2 + 1) + 's';
                confetti.style.opacity = Math.random();
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3000);
            }
        }

function editTodo(dateKey, i, val) { 
            todoStorage[dateKey][i].text = val; 
            // Save to storage but DO NOT call renderTodoView() here
            localStorage.setItem('bar_todos_v2', JSON.stringify(todoStorage));
        }

        function removeTodo(dateKey, i) { 
            todoStorage[dateKey].splice(i, 1); 
            saveAndRefresh(); 
        }

        function saveAndRefresh() {
            localStorage.setItem('bar_todos_v2', JSON.stringify(todoStorage));
            renderTodoView();
        }

// Data and Constants
const studyIcons = [
    // Your core Bar Subject icons
    'gavel', 'shield', 'handshake', 'building-2', 'banknote', 'landmark', 
    // Academic & Document icons
    'book', 'book-open', 'graduation-cap', 'pencil', 'library', 'file-text', 
    'folder', 'clipboard-list', 'scroll', 'bookmark',    
    // Tech & System icons
    'link', 'archive', 'globe', 'database', 'brain', 'search', 'cpu', 'cloud', 'heart'
];

const studyColors = [
    // ROW 1: Deep & Sophisticated (Dark Tones)
    '#5D4037', // Brown
    '#330066', // Deep Purple
    '#1B5E20', // Forest Green
    '#B71C1C', // Deep Red
    '#0D47A1', // Royal Blue
    '#E65100', // Deep Orange
    '#880E4F', // Deep Pink
    '#F57F17', // Golden Yellow
    '#263238', // Gunmetal Gray
    '#311B92', // Indigo
// ROW 2: Deep & Muted
    '#8D6E63', // Soft Clay
    '#FBC02D', // Mustard Yellow
    '#689F38', // Light Olive
    '#EC407A', // Rose
    '#EF5350', // Soft Red
    '#42A5F5', // Sky Blue
    '#AB47BC', // Amethyst
    '#FFA726', // Amber
    '#78909C', // Slate
    '#26A69A'  // Seafoam
];

let selectedIcon = 'link';
let selectedColor = '#00BCD4';
let userLinks = JSON.parse(localStorage.getItem('bar_user_links')) || [];

function toggleLinkModal(show) {
    const modal = document.getElementById('link-modal');
    modal.classList.toggle('hidden', !show);
    modal.classList.toggle('flex', show);
    if(show) setupPickers();
}

// Logic for Link Modal Pickers
function setupPickers() {
    const iconContainer = document.getElementById('icon-picker');
    const colorContainer = document.getElementById('color-picker');
    
    iconContainer.innerHTML = studyIcons.map(icon => `
        <button onclick="selectedIcon='${icon}'; setupPickers()" 
            class="p-1.5 border rounded-lg flex justify-center transition-all ${selectedIcon === icon ? 'border-[#B266FF] bg-purple-50 shadow-sm' : 'border-transparent hover:bg-white'}">
            <i data-lucide="${icon}" class="w-3.5 h-3.5 ${selectedIcon === icon ? 'text-[#330066]' : 'text-gray-400'}"></i>
        </button>
    `).join('');

colorContainer.innerHTML = studyColors.map(color => `
    <button onclick="selectedColor='${color}'; setupPickers()" 
        class="w-8 h-8 rounded-full border-2 transition-all hover:scale-110 active:scale-95 shadow-md ${selectedColor === color ? 'border-[#330066] ring-2 ring-[#B266FF] ring-offset-1' : 'border-white hover:border-gray-200'}" 
        style="background:${color}"></button>
`).join('');
    lucide.createIcons();
}

function saveLink() {
    const title = document.getElementById('link-title').value;
    const url = document.getElementById('link-url').value;
    
    if(!title || !url) return alert("Title and URL required!");

    userLinks.push({ title, url, icon: selectedIcon, color: selectedColor });
    localStorage.setItem('bar_user_links', JSON.stringify(userLinks));
    
    // Reset inputs
    document.getElementById('link-title').value = '';
    document.getElementById('link-url').value = '';
    
    toggleLinkModal(false);
    renderLinks();
}

function deleteLink(index, e) {
    e.preventDefault();
    e.stopPropagation(); // Prevents the link from opening
    
    const linkTitle = userLinks[index].title;
    
    showThemedConfirm(
        "Delete Resource", 
        `Are you sure you want to remove "${linkTitle}"? This cannot be undone.`, 
        () => {
            userLinks.splice(index, 1);
            localStorage.setItem('bar_user_links', JSON.stringify(userLinks));
            renderLinks();
        }
    );
}

function renderLinks() {
    const container = document.getElementById('links-grid');
    container.innerHTML = userLinks.map((link, i) => `
        <a href="${link.url}" target="_blank" class="link-pill" style="background: ${link.color}">
            <div class="w-8 h-8 rounded-lg bg-white/20 flex items-center justify-center mr-3">
                <i data-lucide="${link.icon}" class="w-5 h-5 text-white"></i>
            </div>
            <span>${link.title}</span>
            <div class="flex gap-1">
                <button onclick="editLink(${i}, event)" class="edit-link p-1 bg-black/10 rounded hover:bg-white/20 transition-colors">
                    <i data-lucide="pencil" class="w-3 h-3 text-white"></i>
                </button>
                <button onclick="deleteLink(${i}, event)" class="delete-link p-1 bg-black/10 rounded hover:bg-red-500 transition-colors">
                    <i data-lucide="trash-2" class="w-3 h-3 text-white"></i>
                </button>
            </div>
        </a>
    `).join('');
    lucide.createIcons();
}
 
// --- INITIALIZE ---
window.onload = () => {
    // Set your desired starting tab here
    const defaultTab = 'tab-materials'; 
    
    // 1. Initialize all data trackers first
    renderTodoView();
    renderLinks();
    renderMaterials();
    
    // 2. Pre-load the default subject logic in the background
    lazyLoadSubject('rem', () => {
        updateProgress(); // This ensures subject percentages show up on the buttons immediately
    });

    // 3. Switch to your preferred tab
    switchTab(defaultTab);
};

/* --- THEMED MODAL SYSTEM --- */
function showThemedConfirm(title, message, onConfirm) {
    const container = document.getElementById('themed-modal-container');
    const content = document.getElementById('themed-modal-content');

    content.innerHTML = `
        <div class="modal-header-bg p-4 text-white font-black header-font text-xl tracking-widest uppercase">
            ${title}
        </div>
        <div class="p-6">
            <p class="text-gray-600 font-bold text-sm leading-relaxed">${message}</p>
        </div>
        <div class="p-4 bg-gray-50 flex gap-3">
            <button onclick="closeThemedModal()" class="flex-1 py-3 text-gray-400 font-black uppercase text-[10px] tracking-widest hover:text-gray-600 transition-colors">
                Cancel
            </button>
            <button id="themed-modal-confirm-btn" class="flex-1 py-3 bg-[#330066] text-white font-black uppercase text-[10px] tracking-widest rounded-xl shadow-lg shadow-purple-200 hover:bg-[#B266FF] transition-all">
                Confirm
            </button>
        </div>
    `;

    container.classList.remove('hidden');
    container.classList.add('flex');

    document.getElementById('themed-modal-confirm-btn').onclick = () => {
        onConfirm();
        closeThemedModal();
    };
}

function closeThemedModal() {
    const container = document.getElementById('themed-modal-container');
    container.classList.add('hidden');
    container.classList.remove('flex');
}

let editingLinkIndex = null; // Tracks if we are editing or adding new

function editLink(index, e) {
    e.preventDefault(); // Stop the link from opening
    editingLinkIndex = index;
    const link = userLinks[index];

    // Fill modal with existing data
    document.getElementById('link-title').value = link.title;
    document.getElementById('link-url').value = link.url;
    selectedIcon = link.icon;
    selectedColor = link.color;

    toggleLinkModal(true);
}

// Modify your saveLink function to handle updates
function saveLink() {
    const title = document.getElementById('link-title').value;
    const url = document.getElementById('link-url').value;
    
    if(!title || !url) return alert("Title and URL required!");

    const linkData = { title, url, icon: selectedIcon, color: selectedColor };

    if (editingLinkIndex !== null) {
        // Update existing
        userLinks[editingLinkIndex] = linkData;
        editingLinkIndex = null; // Reset
    } else {
        // Add new
        userLinks.push(linkData);
    }

    localStorage.setItem('bar_user_links', JSON.stringify(userLinks));
    
    // Reset inputs
    document.getElementById('link-title').value = '';
    document.getElementById('link-url').value = '';
    
    toggleLinkModal(false);
    renderLinks();
}

// Also, reset editingLinkIndex when simply opening the modal to add a new link
function toggleLinkModal(show) {
    const modal = document.getElementById('link-modal');
    modal.classList.toggle('hidden', !show);
    modal.classList.toggle('flex', show);
    if(show) {
        setupPickers();
    } else {
        editingLinkIndex = null; // Reset if closed
    }
}

function exportSubjectNotes(sub) {
    const syllabus = SUBJECTS[sub];
    const btn = document.getElementById('sub-btn-' + sub);
    const subjectName = btn ? btn.innerText.split('(')[0].trim() : sub.toUpperCase();
    const themeColor = getActiveThemeColor(sub);
    
    const printWindow = window.open('', '_blank');
    
    function escapeHtml(text) {
        return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    // REDUCED PADDING: Changed from 40px to 20px for wider content
    let printTemplate = `
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Bebas+Neue&display=swap" rel="stylesheet">
        <div style="font-family: 'Inter', sans-serif; padding: 20px; color: #1a1a1a;">
            
            <div style="border-bottom: 5px solid ${themeColor}; margin-bottom: 20px; padding-bottom: 10px;">
                <div style="font-family: 'Bebas Neue', cursive; font-size: 48px; color: ${themeColor}; letter-spacing: 2px; line-height: 1;">
                    #AweSAMBar2026 â€¢ ${subjectName}
                </div>
                <div style="font-size: 10px; font-weight: 800; color: #9ca3af; text-transform: uppercase; margin-top: 5px;">
                    Review Notes â€¢ As of ${new Date().toLocaleDateString()}
                </div>
            </div>`;

    syllabus.forEach((item, i) => {
        const isNote = !(i + 1 < syllabus.length && syllabus[i+1].depth > item.depth);
        const indent = (item.depth - 1) * 20;
        
        // TIGHTER MARGINS: Reduced top margin from 15px to 8px
        let depthStyle = `margin-left: ${indent}px; margin-top: 8px; font-family: 'Inter', sans-serif;`;
        
        if (item.depth === 1) {
            depthStyle = `font-family: 'Inter', sans-serif; font-size: 20px; color: ${themeColor}; margin-top: 30px; margin-bottom: 10px; padding: 8px 15px; background-color: ${themeColor}08; border-left: 5px solid ${themeColor}; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px;`;
        } else if (item.depth === 2) {
            depthStyle += `font-weight: 900; font-size: 15px; text-transform: uppercase; color: #374151; border-bottom: 1px solid #eee; padding-bottom: 3px;`;
        } else if (item.depth === 3) {
            depthStyle += `font-weight: 800; font-size: 13px; color: #4b5563;`;
        } else {
            depthStyle += `font-weight: 700; font-size: 11px; font-style: italic; color: #6b7280;`;
        }
        
        printTemplate += `<div style="${depthStyle}">${item.topic}</div>`;
        
        if (isNote) {
            let path = [];
            let currentD = item.depth;
            for (let j = i - 1; j >= 0; j--) {
                if (syllabus[j].depth < currentD) {
                    path.unshift(syllabus[j].topic);
                    currentD = syllabus[j].depth;
                }
            }
            const key = `note_${sub}_${path.join('_')}_${item.topic}`;
            let rawNote = localStorage.getItem(key) || "";
            const isEmpty = rawNote.trim() === "";

            // LOGIC: If empty, show a blank space with a min-height for handwriting
            printTemplate += `
                <div style="
                    display: block;
                    width: auto;
                    margin-left: ${indent + 20}px; 
                    margin-top: 5px;
                    margin-bottom: 15px;
                    padding-left: 15px; 
                    border-left: 2px solid #e5e7eb; 
                    font-family: 'Inter', sans-serif;
                    min-height: ${isEmpty ? '40px' : 'auto'};
                ">
                    <div style="
                        white-space: pre-wrap; 
                        font-size: 13px; 
                        line-height: 1.6; 
                        color: #1f2937; 
                        word-wrap: break-word;
                        overflow-wrap: break-word;
                    ">
                        ${isEmpty ? '' : escapeHtml(rawNote)}
                    </div>
                </div>`;
        }
    });

    printTemplate += `
            <div style="margin-top: 60px; text-align: center; border-top: 1px solid #eee; padding-top: 20px;">
                <div style="font-family: 'Bebas Neue', cursive; font-size: 16px; color: #9ca3af; letter-spacing: 1px;">
                    Generated via #AweSAMBar2026 Tracker â€¢ 2026bar-reviewtracker.vercel.app
                </div>
                <div style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: ${themeColor}; margin-top: 5px; letter-spacing: 1px;">
                    â€¢ Faith. Grit. Determination. â€¢
                </div>
            </div>
        </div>`;

    printWindow.document.write(printTemplate);
    printWindow.document.close();
    
    setTimeout(() => { printWindow.print(); }, 800);
}

let searchTimeout;
function handleSyllabusSearch(query) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const wrapper = document.getElementById('notes-list-wrapper');
        const searchTerm = query.toLowerCase().trim();
        
        // Reset view if empty
        if (!searchTerm) {
            wrapper.querySelectorAll('details').forEach(d => {
                d.classList.remove('hidden');
                d.open = false;
            });
            return;
        }

        const sub = document.querySelector('.sub-tab-btn.active').dataset.sub;
        const syllabus = SUBJECTS[sub];

        wrapper.querySelectorAll('details').forEach((details, index) => {
            const chapterIdx = parseInt(details.getAttribute('onclick').match(/\d+/)[0]);
            const chapterText = syllabus[chapterIdx].topic.toLowerCase();
            
            // Check if chapter matches OR any subtopic matches
            let hasMatch = chapterText.includes(searchTerm);
            
            // Peek at subtopics for this chapter
            let i = chapterIdx + 1;
            while (i < syllabus.length && syllabus[i].depth > 1) {
                if (syllabus[i].topic.toLowerCase().includes(searchTerm)) {
                    hasMatch = true;
                    break;
                }
                i++;
            }

            if (hasMatch) {
                details.classList.remove('hidden');
                if (searchTerm.length > 2) {
                    details.open = true;
                    renderSubTopics(details, sub, chapterIdx); // Force render if match found
                }
            } else {
                details.classList.add('hidden');
            }
        });
    }, 300);
}

let materialsData = JSON.parse(localStorage.getItem('bar_materials')) || [];
let currentMatEditId = null;
let currentTopicParentId = null;
let currentTopicMatId = null;
let selectedMatIcon = 'book';
let selectedMatColor = '#B266FF';

// --- MATERIAL MODAL LOGIC ---
function openMaterialModal(id = null) {
    currentMatEditId = id;
    const modal = document.getElementById('material-entry-modal');
    const title = document.getElementById('mat-modal-title');
    
    if (id) {
        const mat = materialsData.find(m => m.id === id);
        document.getElementById('mat-name').value = mat.name;
        selectedMatIcon = mat.icon || 'book';
        selectedMatColor = mat.color || '#B266FF';
        title.innerText = "Edit Material";
    } else {
        document.getElementById('mat-name').value = '';
        selectedMatIcon = 'book';
        selectedMatColor = '#B266FF';
        title.innerText = "New Review Material";
    }

    setupMatPickers();
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    lucide.createIcons();
}

// Logic for Material Modal Pickers
function setupMatPickers() {
    const iconContainer = document.getElementById('mat-icon-picker');
    const colorContainer = document.getElementById('mat-color-picker');
    
    iconContainer.innerHTML = studyIcons.map(icon => `
        <button onclick="selectedMatIcon='${icon}'; setupMatPickers()" 
            class="p-1.5 border rounded-lg flex justify-center transition-all ${selectedMatIcon === icon ? 'border-[#B266FF] bg-purple-50 shadow-sm' : 'border-transparent hover:bg-white'}">
            <i data-lucide="${icon}" class="w-3.5 h-3.5 ${selectedMatIcon === icon ? 'text-[#330066]' : 'text-gray-400'}"></i>
        </button>
    `).join('');

    colorContainer.innerHTML = studyColors.map(color => `
        <button onclick="selectedMatColor='${color}'; setupMatPickers()" 
            class="w-8 h-8 rounded-full border-2 transition-transform hover:scale-110 ${selectedMatColor === color ? 'border-[#330066] ring-2 ring-[#B266FF]' : 'border-white shadow-sm'}" 
            style="background:${color}"></button>
    `).join('');
    lucide.createIcons();
}

function saveMaterialEntry() {
    const name = document.getElementById('mat-name').value;
    if (!name) return;

    if (currentMatEditId) {
        const mat = materialsData.find(m => m.id === currentMatEditId);
        mat.name = name;
        mat.icon = selectedMatIcon;
        mat.color = selectedMatColor;
    } else {
        materialsData.push({
            id: Date.now(),
            name: name,
            icon: selectedMatIcon,
            color: selectedMatColor,
            topics: []
        });
    }
    
    closeMaterialModal();
    saveMaterials();
}

function closeMaterialModal() {
    document.getElementById('material-entry-modal').classList.add('hidden');
    document.getElementById('material-entry-modal').classList.remove('flex');
}

// --- TOPIC MODAL LOGIC ---
function addTopic(materialId, parentId = null) {
    currentTopicMatId = materialId;
    currentTopicParentId = parentId;
    
    document.getElementById('topic-title').value = '';
    document.getElementById('topic-trackable').checked = true;
    
    const modal = document.getElementById('topic-entry-modal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    document.getElementById('save-topic-btn').onclick = saveTopicEntry;
}

function saveTopicEntry() {
    const title = document.getElementById('topic-title').value;
    const isTrackable = document.getElementById('topic-trackable').checked;
    if (!title) return;

    const newTopic = {
        id: Date.now(),
        title: title,
        isTrackable: isTrackable,
        done: false,
        subtopics: []
    };

    const material = materialsData.find(m => m.id === currentTopicMatId);
    if (!currentTopicParentId) {
        material.topics.push(newTopic);
    } else {
        const findRecursive = (list) => {
            for (let t of list) {
                if (t.id === currentTopicParentId) { t.subtopics.push(newTopic); return true; }
                if (t.subtopics && findRecursive(t.subtopics)) return true;
            }
        };
        findRecursive(material.topics);
    }
    closeTopicModal();
    saveMaterials();
}

function closeTopicModal() {
    document.getElementById('topic-entry-modal').classList.add('hidden');
    document.getElementById('topic-entry-modal').classList.remove('flex');
}

// --- RENDER & CORE LOGIC ---
function renderMaterials() {
    const container = document.getElementById('materials-grid');
    if (!container) return;
    
container.innerHTML = materialsData.map(m => {
        // Progress Calculation Logic
        let totalTrackable = 0;
        let doneTrackable = 0;

        const countProgress = (list) => {
            list.forEach(t => {
                if (t.isTrackable) { 
                    totalTrackable++; 
                    if (t.done) doneTrackable++; 
                }
                if (t.subtopics && t.subtopics.length > 0) countProgress(t.subtopics);
            });
        };
        countProgress(m.topics);

        const toReadCount = totalTrackable - doneTrackable;
        const percent = totalTrackable === 0 ? 0 : Math.round((doneTrackable / totalTrackable) * 100);

        // Dynamic Progress Color Logic
        let barColor = '#ef4444'; // Red (0-25%)
        if (percent > 25) barColor = '#f97316'; // Orange
        if (percent > 50) barColor = '#eab308'; // Yellow
        if (percent > 75) barColor = '#22c55e'; // Green

const isCollapsed = m.collapsed || false; // Check saved state

return `
        <div class="material-panel bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6" style="--panel-color: ${m.color}">
            <div class="p-4 flex flex-col gap-3 text-white cursor-pointer" style="background-color: ${m.color}" onclick="toggleCollapse(${m.id}, event)">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-white/20 shadow-inner">
                            <i data-lucide="${m.icon}" class="w-5 h-5 text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-black uppercase text-sm tracking-widest text-white">${m.name}</h3>
                            <p class="text-[9px] font-bold text-white/60 italic tracking-wide mt-0.5">Review Material Tracker â€¢ ${isCollapsed ? 'Press to Expand' : 'Press to Collapse'}</p>
                        </div>
                    </div>
                    <div class="flex gap-1" onclick="event.stopPropagation()"> <div class="flex items-center bg-white/10 rounded-lg px-1 mr-1">
                            <button onclick="moveMaterial(${m.id}, -1)" class="p-1 text-white/70 hover:text-white"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                            <button onclick="moveMaterial(${m.id}, 1)" class="p-1 text-white/70 hover:text-white"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                        <button onclick="addTopic(${m.id})" class="text-[10px] font-black bg-white/20 hover:bg-white/40 text-white border border-white/30 px-3 py-1.5 rounded-lg">+ TOPIC</button>
                        <button onclick="openMaterialModal(${m.id})" class="p-2 text-white/70 hover:text-white"><i data-lucide="settings" class="w-4 h-4"></i></button>
                        <button onclick="deleteMaterial(${m.id})" class="p-2 text-white/70 hover:text-red-300"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <div class="flex flex-wrap items-center gap-4 px-1">
                    <div class="flex items-center gap-1.5">
                        <i data-lucide="check-circle" class="w-3.5 h-3.5 opacity-80"></i>
                        <span class="text-[10px] font-black uppercase tracking-tighter">DONE: ${doneTrackable} TOPICS</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <i data-lucide="book-open" class="w-3.5 h-3.5 opacity-80"></i>
                        <span class="text-[10px] font-black uppercase tracking-tighter">TO READ: ${toReadCount} TOPICS</span>
                    </div>
                    <div class="flex-grow flex items-center gap-3">
                        <span class="text-[10px] font-black uppercase tracking-tighter whitespace-nowrap">OVERALL PROGRESS:</span>
                        <div class="flex-grow h-2 bg-white/20 rounded-full overflow-hidden border border-white/10 shadow-inner">
                            <div class="h-full transition-all duration-700 ease-out" style="width: ${percent}%; background-color: ${barColor}"></div>
                        </div>
                        <span class="text-[10px] font-black">${percent}%</span>
                    </div>
                </div>
            </div>

<div class="p-4 space-y-1 ${isCollapsed ? 'hidden' : ''}"> 
                ${m.topics.length === 0 
? `<p class="font-family text-[18px] text-center text-gray-400 italic py-6">
    No topics added yet. 
    <span class="block mt-2 text-xs not-italic font-bold text-[#B266FF]">
        Click + TOPIC to start tracking.
    </span>
</p>`
                    : renderTopicsRecursive(m.topics, m.id)}
            </div>
        </div>`;

    }).join('');
    lucide.createIcons();
}

// Add this global state at the top of your script
let collapsedTopics = JSON.parse(localStorage.getItem('bar_collapsed_topics')) || {};

function renderTopicsRecursive(topics, materialId) {
    return topics.map((t) => {
        const hasChildren = t.subtopics && t.subtopics.length > 0;
        const isCollapsed = collapsedTopics[t.id] || false;
        const textStyle = !t.isTrackable ? 'text-[#330066] font-black uppercase' : (t.done ? 'line-through text-gray-400' : 'text-gray-700');

        return `
        <div class="topic-wrapper mb-1">
            <div class="flex items-center justify-between py-1 trackable-item group">
                <div class="flex items-center gap-2 flex-grow min-w-0">
                    <div onclick="${hasChildren ? `toggleTopicCollapse(${t.id})` : ''}" 
                         class="cursor-pointer p-1 -ml-1 transition-transform ${isCollapsed ? '' : 'rotate-90'} ${hasChildren ? 'opacity-100' : 'opacity-20'}">
                        <i data-lucide="chevron-right" class="w-3.5 h-3.5 text-[#B266FF]"></i>
                    </div>
                    
                    ${t.isTrackable ? 
                        `<input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleMaterialItem(${materialId}, ${t.id})" class="w-4 h-4 rounded border-purple-300">` : ''}
                    
                    <textarea 
                        rows="1" 
                        oninput="autoExpand(this); updateTopicTitle(${materialId}, ${t.id}, this.value)" 
                        class="bg-transparent border-none outline-none flex-grow resize-none overflow-hidden text-xs ${textStyle}"
                    >${t.title}</textarea>
                </div>
                
                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity ml-2">
                    <div class="flex flex-col -space-y-1 mr-1">
                        <button onclick="moveTopic(${materialId}, ${t.id}, -1)" class="text-gray-300 hover:text-[#B266FF] transition-colors">
                            <i data-lucide="chevron-up" class="w-3 h-3"></i>
                        </button>
                        <button onclick="moveTopic(${materialId}, ${t.id}, 1)" class="text-gray-300 hover:text-[#B266FF] transition-colors">
                            <i data-lucide="chevron-down" class="w-3 h-3"></i>
                        </button>
                    </div>

                    <button onclick="addTopic(${materialId}, ${t.id})" class="text-[9px] text-[#B266FF] font-black uppercase tracking-tighter">+ Sub</button>
                    <button onclick="deleteTopic(${materialId}, ${t.id})" class="text-red-300 hover:text-red-500">
                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                </div>
            </div>

            <div class="nested-topic ${isCollapsed ? 'hidden' : ''}">
                ${renderTopicsRecursive(t.subtopics, materialId)}
            </div>
        </div>`;
    }).join('');
}

// Add this function to handle the live data updates
function updateTopicTitle(materialId, topicId, newVal) {
    const material = materialsData.find(m => m.id === materialId);
    const findAndUpdate = (list) => {
        for (let t of list) {
            if (t.id === topicId) { 
                t.title = newVal; 
                return true; 
            }
            if (t.subtopics && findAndUpdate(t.subtopics)) return true;
        }
    };
    findAndUpdate(material.topics);
    // We save to localStorage but DON'T re-render the whole list to prevent losing focus/cursor position
    localStorage.setItem('bar_materials', JSON.stringify(materialsData));
}

function toggleMaterialItem(materialId, topicId) {
    const material = materialsData.find(m => m.id === materialId);
    let justFinished = false;

    // Helper function to mark all descendants as done/undone
    const markDescendants = (list, isDone) => {
        list.forEach(t => {
            t.done = isDone;
            if (t.subtopics && t.subtopics.length > 0) markDescendants(t.subtopics, isDone);
        });
    };

    const findAndToggle = (list) => {
        for (let t of list) {
            if (t.id === topicId) { 
                t.done = !t.done; 
                if (t.done) justFinished = true;
                
                // If this is a parent, apply the same state to all children
                if (t.subtopics && t.subtopics.length > 0) {
                    markDescendants(t.subtopics, t.done);
                }
                return true; 
            }
            if (t.subtopics && findAndToggle(t.subtopics)) return true;
        }
    };

    findAndToggle(material.topics);
    if (justFinished) createConfetti();
    saveMaterials();
}


function deleteMaterial(id) {
    const mat = materialsData.find(m => m.id === id);
    showThemedConfirm(
        "Delete Material", 
        `Are you sure you want to remove "${mat.name}"? This will delete all tracked progress.`, 
        () => {
            materialsData = materialsData.filter(m => m.id !== id);
            saveMaterials();
        }
    );
}

function saveMaterials() {
    localStorage.setItem('bar_materials', JSON.stringify(materialsData));
    renderMaterials();
}

function deleteTopic(materialId, topicId) {
    showThemedConfirm(
        "Delete Topic", 
        "Remove this topic and all its sub-topics?", 
        () => {
            const material = materialsData.find(m => m.id === materialId);
            const findAndDelete = (list, id) => {
                const index = list.findIndex(t => t.id === id);
                if (index !== -1) {
                    list.splice(index, 1);
                    return true;
                }
                for (let t of list) {
                    if (t.subtopics && findAndDelete(t.subtopics, id)) return true;
                }
            };
            findAndDelete(material.topics, topicId);
            saveMaterials(); // Save and refresh UI
        }
    );
}

function moveTopic(materialId, topicId, direction) {
    const material = materialsData.find(m => m.id === materialId);
    
    const findAndMove = (list) => {
        const index = list.findIndex(t => t.id === topicId);
        if (index !== -1) {
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < list.length) {
                // Swap elements in the array
                const temp = list[index];
                list[index] = list[newIndex];
                list[newIndex] = temp;
                return true;
            }
            return false;
        }
        for (let t of list) {
            if (t.subtopics && findAndMove(t.subtopics)) return true;
        }
        return false;
    };

    if (findAndMove(material.topics)) {
        saveMaterials(); // This re-renders everything to show the new order
    }
}
function moveMaterial(id, direction) {
    const index = materialsData.findIndex(m => m.id === id);
    if (index === -1) return;

    const newIndex = index + direction;
    if (newIndex >= 0 && newIndex < materialsData.length) {
        // Swap materials in the array
        const temp = materialsData[index];
        materialsData[index] = materialsData[newIndex];
        materialsData[newIndex] = temp;
        
        saveMaterials(); // Save to localStorage and refresh the grid
    }
}

function toggleCollapse(id, event) {
    const mat = materialsData.find(m => m.id === id);
    if (mat) {
        mat.collapsed = !mat.collapsed;
        saveMaterials(); // Save the collapsed state to localStorage
    }
}

function toggleTopicCollapse(topicId) {
    collapsedTopics[topicId] = !collapsedTopics[topicId];
    localStorage.setItem('bar_collapsed_topics', JSON.stringify(collapsedTopics));
    renderMaterials(); // Refresh to show/hide
}

</script>

<div id="themed-modal-container" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[200] p-4">
    <div id="themed-modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden modal-animate-in border border-purple-100">
        </div>
</div>
</body>
</html>
